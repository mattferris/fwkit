# fwkit - rules.d/pre/10dnat.rules

$fwkit config get | grep vars.dnat_ | {
    while read def; do
        name=$(echo $def | cut -d' ' -f1)
        spec=$(echo $def | cut -d' ' -f3)

        proto=$(echo $spec | cut -d'/' -f1)
        src=$(echo $spec | cut -d'/' -f2)
        dst=$(echo $spec | cut -d'/' -f3)

        if [ ! "$proto" = "tcp" -a ! "$proto" = "udp" ]; then
            echo "warning: bad DNAT specification '$spec' in variable $name: bad protocol '$proto', must be tcp or udp, ignoring"
            continue
        fi

        if [ "$src" = "$dst" ]; then
            echo "warning: bad DNAT specification '$spec' in variable $name: missing source or destination, ignoring"
            continue
        fi

        src_addr=$(echo $src | cut -d: -f1)
        src_port=$(echo $src | cut -d: -f2)

        if [ -z "$src_port" ]; then
            echo "warning: bad DNAT specification '$spec' in variable $name: missing source port, ignoring"
            continue
        fi

        src_def=""
        if [ ! -z "$src_addr" ]; then
            src_def="-s $src_addr"
        fi

        iptables -t nat -A PREROUTING $src_def -p $proto --dport $src_port -m comment --comment "auto rule generated by rules.d/pre/10dnat.rules for $name" -j DNAT --to-destination $dst
        echo iptables -t nat -A PREROUTING $src_def -p $proto --dport $src_port -m comment --comment "auto rule generated by rules.d/pre/10dnat.rules for $name" -j DNAT --to-destination $dst >> "$FWKIT_LIBDIR/unload.rules"
    done
}
